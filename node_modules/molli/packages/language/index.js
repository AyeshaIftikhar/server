const fs = require('fs')
const path = require('path')
const buildAL = require('./buildAL')
const format = require('./format')
const genSupAPI = require('./genSupAPI')
const genRelatedAPI = require('./genRelatedAPI')
const supTypes = require('./supTypes')
const { Hub, Event, Store } = require('../state')

Hub.on(Event.GQL_UPDATED, () => {
  const { gql: { content } } = Store.get()
  const accessList = buildAL(content, supTypes)
  const { mutation, query, timeDefs, relatedAPIs } = genSupAPI(accessList)
  const defs = genRelatedAPI(accessList, relatedAPIs)
  const genList = defs.concat(supTypes).concat([ mutation, query]).concat(timeDefs)
  const genText = format(accessList, genList)
  const state = Store.get()
  state.gql.set({
    genText,
    accessList,
    genList,
    supTypes,
    mutation,
    query,
  })
  Hub.emit(Event.API_UPDATED)
})
