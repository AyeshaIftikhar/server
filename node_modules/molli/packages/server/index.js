const express = require('express')
const bodyParser = require('body-parser')
const { graphqlExpress, graphiqlExpress } = require('apollo-server-express')
const Logger = require('../logger')
const { Store } = require('../state')

const app = express()
const PORT = process.env.PORT || 3000
app.use('/graphql',
  bodyParser.json() ,
  graphqlExpress(req => {
    const state = Store.get()
    return state.server.gqlEntry(req)
  })
)
app.use('/graphiql',
  graphiqlExpress({ endpointURL: '/graphql' })
)
app.listen(PORT, () => {
  Logger.info('Server is started')
  Logger.info(`Graphql  : http://127.0.0.1:${PORT}/graphql`)
  Logger.info(`Graphiql : http://127.0.0.1:${PORT}/graphiql`)
})

module.exports = app
