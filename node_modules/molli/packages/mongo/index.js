const { MongoClient } = require('mongodb')
const { Store, Hub, Event } = require('../state')
const { Assert } = require('../type')

Hub.on(Event.STARTUP, () => {
  const { MONGO_URL } = process.env
  if (!MONGO_URL) throw new Error('MONGO_URL is not found')
  MongoClient.connect(MONGO_URL, (error, db) => {
    if (error) throw new Error('Connection problem')
    const state = Store.get()
    state.mongo.set({ db })
    Hub.emit(Event.MONGO_CONNECTED)
  })
})
