const chokidar = require('chokidar')
const path = require('path')
const fs = require('fs')
const Kind = require('../kind')
const Logger = require('../logger')
const { Hub, Event, Store } = require('../state')

Hub.on(Event.MONGO_CONNECTED, () => {
  const { gql: { name, content }, cwd } = Store.get()
  const gql = path.resolve(cwd, name)
  const readFile = f => fs.readFileSync(f, { encoding: 'utf8' })
  const saveContent = (content = '') => {
    const state = Store.get()
    state.gql.set({ content })
    Hub.emit(Event.GQL_UPDATED)
    Logger.info(`${name} is updated`)
  }
  chokidar.watch(gql)
    .on('add', () => saveContent(readFile(gql)))
    .on('change', () => saveContent(readFile(gql)))
    .on('unlink', () => saveContent())
})
